# ====================================================================
# Makefile for Device Tree Blob (DTB) Generation
# Automates preprocessing and compilation of DTS files for Xilinx Zynq/MPSoC
# ====================================================================

# --- Configuration Variables ---
# Network boot IP configuration
# These must be passed as make parameters or defined in the parent Makefile
# They are read from build/conf/local.conf by the parent Makefile
ifndef BOARD_IP
    $(error BOARD_IP is not defined. This must be defined in build/conf/local.conf and passed from the parent Makefile)
endif
ifndef BOARD_GATEWAY
    $(error BOARD_GATEWAY is not defined. This must be defined in build/conf/local.conf and passed from the parent Makefile)
endif
ifndef BOARD_NETMASK
    $(error BOARD_NETMASK is not defined. This must be defined in build/conf/local.conf and passed from the parent Makefile)
endif
ifndef NFS_SERVER
    $(error NFS_SERVER is not defined. This must be defined in build/conf/local.conf and passed from the parent Makefile)
endif
ifndef NFS_ROOT
    $(error NFS_ROOT is not defined. This must be defined in build/conf/local.conf and passed from the parent Makefile)
endif

# Convert IP addresses to CPP-friendly format (replace dots with commas for string concatenation)
# We'll pass these as string defines to the preprocessor
CPPFLAGS += -DBOARD_IP="\"$(BOARD_IP)\""
CPPFLAGS += -DBOARD_GATEWAY="\"$(BOARD_GATEWAY)\""
CPPFLAGS += -DBOARD_NETMASK="\"$(BOARD_NETMASK)\""
CPPFLAGS += -DNFS_SERVER="\"$(NFS_SERVER)\""
CPPFLAGS += -DNFS_ROOT="\"$(NFS_ROOT)\""

# The main DTS file generated by XSCT
# This file includes all other .dtsi files
DTS_MAIN_FILE := system-top.dts

# The final binary output file expected by U-Boot/Linux Kernel
DTB_OUTPUT_FILE := system.dtb

# Base DTB file (compiled from system-top.dts before overlays)
DTB_BASE_FILE := system-base.dtb

# Temporary file used to hold the flattened, preprocessed source
DTS_TEMP_FILE := system.dts.tmp

# Overlay Source Files
# Order is important: zynqmp-sck-kr-g-revB.dtso must be applied before kr260_overlay.dtso
DTSO_FILES := zynqmp-sck-kr-g-revB.dtso kr260_overlay.dtso
# Compiled Overlay Files
DTBO_FILES := $(DTSO_FILES:.dtso=.dtbo)

# --- Tools Configuration ---

# C Preprocessor (part of GCC)
CPP := gcc

# Device Tree Compiler - make sure this is installed on your host system
DTC := dtc

# --- Targets ---

.PHONY: all clean

# Default target: builds the final DTB file
all: $(DTB_OUTPUT_FILE)
	@echo "Successfully generated the final Device Tree Blob: $(DTB_OUTPUT_FILE)"

# Rule to merge overlays into the final DTB
$(DTB_OUTPUT_FILE): $(DTB_BASE_FILE) $(DTBO_FILES)
	@echo "Applying overlays to base DTB..."
	# fdtoverlay applies each overlay in order.
	fdtoverlay -i $(DTB_BASE_FILE) -o $@ $(DTBO_FILES)
	@echo "Overlay application complete."

# Rule to compile the base DTB
# Note: -@ flag is added to generate symbols, allowing overlays to resolve references
$(DTB_BASE_FILE): $(DTS_TEMP_FILE)
	@echo "Compiling flattened source ($(DTS_TEMP_FILE)) to binary DTB (with symbols)..."
	$(DTC) -@ -I dts -O dtb -o $@ $<
	@echo "Base DTB compilation complete."

# Rule to preprocess (flatten) all DTS/DTSI files
$(DTS_TEMP_FILE): $(DTS_MAIN_FILE)
	@echo "Preprocessing DTS files (merging all .dtsi into a single file)..."
	$(CPP) -I . -I include -E -nostdinc -undef -D__DTS__ $(CPPFLAGS) -x assembler-with-cpp -o $@ $<
	@echo "Preprocessing complete. Source saved to $(DTS_TEMP_FILE)"

# Rule to compile overlays (.dtso -> .dtbo)
%.dtbo: %.dtso
	@echo "Processing overlay $<..."
	# Preprocess the overlay file first (with IP configuration defines)
	$(CPP) -I . -I include -E -nostdinc -undef -D__DTS__ $(CPPFLAGS) -x assembler-with-cpp -o $(@:.dtbo=.dtso.tmp) $<
	# Compile the preprocessed overlay
	$(DTC) -@ -I dts -O dtb -o $@ $(@:.dtbo=.dtso.tmp)
	# Remove temporary preprocessed file
	rm $(@:.dtbo=.dtso.tmp)
	@echo "Overlay $< compiled to $@"

# Rule to clean up generated files
clean:
	@echo "Cleaning up temporary and output files..."
	rm -f $(DTS_TEMP_FILE) $(DTB_OUTPUT_FILE) $(DTB_BASE_FILE) $(DTBO_FILES)
	@echo "Cleaning up complete."
